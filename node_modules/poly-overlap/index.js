"use strict";

var pu = {};

function on_seg(xi, yi, xj, yj, xk, yk) {
    return (xi <= xk || xj <= xk) && (xk <= xi || xk <= xj) &&
        (yi <= yk || yj <= yk) && (yk <= yi || yk <= yj);
}

function dir(xi, yi, xj, yj, xk, yk) {
    var a = (xk - xi) * (yj - yi);
    var b = (xj - xi) * (yk - yi);
    return a < b ? -1 : a > b ? 1 : 0;
}

// http://ptspts.blogspot.no/2010/06/how-to-determine-if-two-line-segments.html
pu.intersect = function (x1, y1, x2, y2, x3, y3, x4, y4) {
    // console.log("%d %d %d %d %d %d %d %d ", x1, y1, x2, y2, x3, y3, x4, y4);
    var d1 = dir(x3, y3, x4, y4, x1, y1);
    var d2 = dir(x3, y3, x4, y4, x2, y2);
    var d3 = dir(x1, y1, x2, y2, x3, y3);
    var d4 = dir(x1, y1, x2, y2, x4, y4);
    return (((d1 > 0 && d2 < 0) || (d1 < 0 && d2 > 0)) &&
            ((d3 > 0 && d4 < 0) || (d3 < 0 && d4 > 0))) ||
                (d1 === 0 && on_seg(x3, y3, x4, y4, x1, y1)) ||
                    (d2 === 0 && on_seg(x3, y3, x4, y4, x2, y2)) ||
                        (d3 === 0 && on_seg(x1, y1, x2, y2, x3, y3)) ||
                            (d4 === 0 && on_seg(x1, y1, x2, y2, x4, y4));
};

pu.bounds = function (poly) {
    var xs = [], ys = [];

    for (var i = 0; i < poly.length; i++) {
        xs.push(poly[i][0]);
        ys.push(poly[i][1]);
    }
    xs = xs.sort(function (a, b) {
        return a - b;
    });
    ys = ys.sort(function (a, b) {
        return a - b;
    });

    return [
        [xs[0], ys[0]],
        [xs[xs.length - 1], ys[ys.length - 1]]
    ];
};

// http://www.ecse.rpi.edu/Homepages/wrf/Research/Short_Notes/pnpoly.html
pu.inside = function (p, poly) {
    var i, j, c = false, nvert = poly.length;
    for (i = 0, j = nvert - 1; i < nvert; j = i++) {
        if (((poly[i][1] > p[1]) !== (poly[j][1] > p[1])) &&
            (p[0] < (poly[j][0] - poly[i][0]) * (p[1] - poly[i][1]) / (poly[j][1] - poly[i][1]) + poly[i][0])) {
                c = !c;
            }
    }
    return c;
};

pu.polyPointInside = function (p0, p1) {
    for (var i = 0; i < p0.length; i += 1) {
        for (var j = 0; j < p1.length; j += 1) {

            if (pu.inside(p0[i], p1)) {
                return true;
            }

            if (pu.inside(p1[j], p0)) {
                return true;
            }
        }
    }
    return false;
};

pu.polyEdgesOverlap = function (p0, p1) {
    for (var i = 0; i < p0.length - 1; i += 1) {
        for (var j = 0; j < p1.length - 1; j += 1) {
            if (pu.intersect(
                p0[i][0], p0[i][1], p0[i + 1][0], p0[i + 1][1],
            p1[j][0], p1[j][1], p1[j + 1][0], p1[j + 1][1])) {
                return true;
            }
        }
    }
    return false;
};

// http://math.stackexchange.com/questions/254569/concave-polygons-overlapping-test
pu.overlap = function (p0, p1) {

    // polygons overlap if either

    // 1. one of the points of one polygon is inside the other polygon polygon
    if (pu.polyPointInside(p0, p1)) {
        return true;
    }

    // 2. one of the edges overlap
    if (pu.polyEdgesOverlap(p0, p1)) {
        return true;
    }

    return false;
};

if (typeof module !== 'undefined' && module.exports) {
    module.exports = pu;
}

